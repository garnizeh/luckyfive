# Algorithm Refactoring Plan

This document captures the analysis and extraction plan for the prediction algorithms currently implemented in `old/tools/loader/loader.go`.

## Functions to Port
1. `generateAdvancedPredictions` -> `pkg/predictor/advanced.go`
2. `computeFreq`, `computePairwiseConditional`, `computeMarginalProbabilities`, `computePosFreq` -> `pkg/predictor/frequency.go`
3. `evolvePopulation`, `hillClimbRefine`, `evolvePopulation` -> `pkg/predictor/evolutionary.go`
4. `scoreCandidate`, `scoreCandidate` helpers and `scoreCandidate` usage -> `pkg/predictor/scorer.go`

## Changes Needed
- Remove CLI global state and move functions into testable packages.
- Inject random seed (`*rand.Rand`) or `rand.Source` to make algorithms deterministic for tests.
- Add `context.Context` cancellation points where long-running loops exist.
- Replace package-level helper functions with methods on types where appropriate (e.g. `AdvancedPredictor`).
- Add small, focused unit tests for each pure function and integration tests for `AdvancedPredictor` using fixed seeds.

## Design: Public interfaces

We will expose two primary interfaces so the engine and services can depend on abstractions:

```go
type Predictor interface {
    GeneratePredictions(ctx context.Context, params PredictionParams) ([]Prediction, error)
}

type Scorer interface {
    ScorePredictions(predictions []Prediction, actual []int) *ScoreResult
}
```

Where concrete implementations live under `pkg/predictor` and implement the above.

## Suggested package layout

- `pkg/predictor/types.go` — shared types and interfaces
- `pkg/predictor/advanced.go` — port of `generateAdvancedPredictions` as `AdvancedPredictor`
- `pkg/predictor/frequency.go` — `computeFreq`, `computePairwiseConditional`, `computePosFreq`, `computeMarginalProbabilities`
- `pkg/predictor/evolutionary.go` — population evolution helpers
- `pkg/predictor/scorer.go` — scoring helpers for predictions

## Testing plan

- Unit tests for each frequency/evolution/scorer function (table-driven).
- Deterministic integration test for `AdvancedPredictor.GeneratePredictions` using a fixed seed and small synthetic history.
- Benchmarks for `GeneratePredictions` and `ScorePredictions` to validate performance.

## Next steps
1. Create `pkg/predictor` package skeleton and types (interfaces + simple structs).
2. Port pure helpers (frequency, pos-freq, marginal) and add unit tests.
3. Port evolution/hill-climb with `*rand.Rand` injected and context support.
4. Implement `AdvancedPredictor` wrapper that composes helpers and exposes `GeneratePredictions`.
5. Add tests and iterate until behavior matches current CLI results (optionally compare sample outputs).

---
Generated by automation as part of Task 2.1.1
