# --- Configura√ß√µes Gerais ---
GO=go
BIN_MAIN=tools/loader/loader.go
BIN_COMPARE=tools/simulations/compare_simulations.go
BIN_CONCURRENCY=tools/sweep/concurrent_sweep.go
BIN_THINKER=tools/thinker/thinker.go
# Bin√°rio pr√©-compilado para rodar o sweep mais r√°pido
# On Windows the executable will have a .exe suffix; set EXE accordingly
EXE :=
ifeq ($(OS),Windows_NT)
EXE := .exe
endif
MAIN_BIN=./main_bin$(EXE)
THINKER_BIN=./thinker_bin$(EXE)
DATA_DIR=data
SIM_OUT=$(DATA_DIR)/simulations
DB=$(DATA_DIR)/dados.db

# --- Par√¢metros da Simula√ß√£o (Backtesting) ---
SIM_START=6877
SIM_END=6881
SIM_PREV_MAX=200
SIM_PREDS=25
# Quantas vezes repetir a mesma simula√ß√£o para validar consist√™ncia
REPEAT=5 

# --- Par√¢metros do Modelo (Ajuste Fino) ---
LAMBDA=0.08
HOT_COLD_BOOST=1.5
ALPHA=1.5
BETA=0.5
GAMMA=1.0
CLUSTER_PENALTY=2.0
CANDS_MULT=100
HILL_ITER=100
COOCC_WINDOW=100
HOT_WINDOW=15
SMART_FILTERS=true
SEED=0

# --- Par√¢metros de Gera√ß√£o (Produ√ß√£o) ---
GEN_GAMES=10

# Constr√≥i a string de argumentos para a simula√ß√£o
SIM_ARGS=--db $(DB) --load=false \
	--sim-start=$(SIM_START) --sim-end=$(SIM_END) \
	--sim-prev-max=$(SIM_PREV_MAX) --sim-preds=$(SIM_PREDS) \
	--lambda=$(LAMBDA) --hot-cold-boost=$(HOT_COLD_BOOST) \
	--alpha=$(ALPHA) --beta=$(BETA) --gamma=$(GAMMA) \
	--cluster-penalty=$(CLUSTER_PENALTY) \
	--cands-mult=$(CANDS_MULT) --hill-iter=$(HILL_ITER) \
	--coocc-window=$(COOCC_WINDOW) --hot-window=$(HOT_WINDOW) \
	--smart-filters=$(SMART_FILTERS) \
	--sim-save=true --sim-out=$(SIM_OUT) --seed=$(SEED)

# --- Par√¢metros de Sweep (Otimiza√ß√£o de Portf√≥lio) ---
PORTFOLIO_RUNS=100
MIN_PREDS=10   # M√≠nimo de jogos a testar (por configura√ß√£o)
MAX_PREDS=25   # M√°ximo de jogos a testar (por configura√ß√£o)
PREDS_STEP=5   # Incremento no n√∫mero de jogos (10, 15, 20, 25)

# Range de Par√¢metros para Randomiza√ß√£o (Mais fino para o teste)
ALPHA_MIN=0.8
ALPHA_MAX=2.5
BETA_MIN=0.1
BETA_MAX=1.0
LAMBDA_MIN=0.05
LAMBDA_MAX=0.15

# CMD base para o portfolio sweep (sem SIM_PREDS, Alpha, Beta, Lambda, SmartFilters)
PORTFOLIO_BASE_CMD=--db $(DB) --load=false \
	--sim-start=$(SIM_START) --sim-end=$(SIM_END) \
	--sim-prev-max=$(SIM_PREV_MAX) \
	--hot-cold-boost=$(HOT_COLD_BOOST) --gamma=$(GAMMA) \
	--cluster-penalty=$(CLUSTER_PENALTY) \
	--cands-mult=$(CANDS_MULT) --hill-iter=$(HILL_ITER) \
	--coocc-window=$(COOCC_WINDOW) --hot-window=$(HOT_WINDOW) \
	--sim-save=true --sim-out=$(SIM_OUT) --sim-clean=false

# CMD base para o sweep (exclui Alpha, Beta, Lambda, SmartFilters que ser√£o randomizados)
MEGA_SWEEP_BASE_CMD=--db $(DB) --load=false \
	--sim-start=$(SIM_START) --sim-end=$(SIM_END) \
	--sim-prev-max=$(SIM_PREV_MAX) --sim-preds=$(SIM_PREDS) \
	--hot-cold-boost=$(HOT_COLD_BOOST) --gamma=$(GAMMA) \
	--cluster-penalty=$(CLUSTER_PENALTY) \
	--cands-mult=$(CANDS_MULT) --hill-iter=$(HILL_ITER) \
	--coocc-window=$(COOCC_WINDOW) --hot-window=$(HOT_WINDOW) \
	--sim-save=true --sim-out=$(SIM_OUT) --sim-clean=false

# --- Concorr√™ncia ---
# Defina o n√∫mero exato de threads
NUM_THREADS=27
# Se voc√™ quiser que o padr√£o seja NumCPU - 1, deixe a linha acima com apenas NUM_THREADS?=

# --- Regras de Build e Setup ---

.PHONY: build setup clean

# Regra Build: Compila o main.go para um bin√°rio execut√°vel
build: $(MAIN_BIN)

$(MAIN_BIN): $(BIN_MAIN)
	@echo "üõ†Ô∏è Compilando $(BIN_MAIN) para bin√°rio..."
	$(GO) build -o $(MAIN_BIN) $(BIN_MAIN)

# Compila o utilit√°rio thinker (tools/thinker/thinker.go) para um bin√°rio
thinker: $(THINKER_BIN)

$(THINKER_BIN): $(BIN_THINKER)
	@echo "üõ†Ô∏è Compilando $(BIN_THINKER) para bin√°rio..."
	$(GO) build -o $(THINKER_BIN) $(BIN_THINKER)

# --- Targets ---

.PHONY: help setup init-db sim run clean compare sweep sweep-alpha thinker

help: ## Mostra esta ajuda
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## Cria diret√≥rios necess√°rios
	@mkdir -p $(DATA_DIR)
	@mkdir -p $(SIM_OUT)

# Inicializa o banco `data/dados.db` a partir do Excel `data/Quina.xlsx`
init-db: setup
	@echo "üì• Inicializando banco $(DB) a partir de data/Quina.xlsx..."
	# Pass --gen-games=0 to avoid the default generation output during init
	$(GO) run $(BIN_MAIN) --db $(DB) --load=true --gen-games=0

sim: setup ## Roda uma √∫nica simula√ß√£o com os par√¢metros atuais
	@echo "üöÄ Iniciando Simula√ß√£o..."
	$(GO) run $(BIN_MAIN) $(SIM_ARGS) --sim-clean=false
	@$(MAKE) compare

run: setup ## Gera jogos REAIS para o pr√≥ximo concurso (Modo Produ√ß√£o)
	@echo "üé≤ Gerando $(GEN_GAMES) jogos otimizados para aposta..."
	$(GO) run $(BIN_MAIN) --db $(DB) --load=false --gen-games=$(GEN_GAMES) \
		--lambda=$(LAMBDA) --alpha=$(ALPHA) --beta=$(BETA) --smart-filters=$(SMART_FILTERS)

compare: ## Analisa os resultados das simula√ß√µes (ordena por Quina)
	@echo "üìä Comparando resultados..."
	$(GO) run $(BIN_COMPARE) -dir $(SIM_OUT) -n 20 -sort quina

clean:
	@echo "üßπ Limpando data/simulations..."
	rm -rf $(SIM_OUT)/*
	@echo "üßπ Limpando bin√°rio..."
	# Remove o bin√°rio para for√ßar a recompila√ß√£o se necess√°rio
	rm -f $(MAIN_BIN)	

# --- Testes de Estrat√©gia (Grid Search) ---

sweep: sweep-alpha compare ## Roda teste comparativo variando Alpha (1.0, 1.5, 2.0)

sweep-alpha: setup
	@echo "üß™ Testando Alpha = 1.0 (Conservador)..."
	$(GO) run $(BIN_MAIN) $(SIM_ARGS) --alpha=1.0 --sim-clean=false
	@echo "üß™ Testando Alpha = 1.5 (Balanceado)..."
	$(GO) run $(BIN_MAIN) $(SIM_ARGS) --alpha=1.5 --sim-clean=false
	@echo "üß™ Testando Alpha = 2.5 (Focado em Pares)..."
	$(GO) run $(BIN_MAIN) $(SIM_ARGS) --alpha=2.5 --sim-clean=false

# Roda simula√ß√£o r√°pida para debug
quick: 
	$(GO) run $(BIN_MAIN) $(SIM_ARGS) --cands-mult=20 --hill-iter=10 --sim-clean=false

compare-top5: ## Analisa os TOP 5 resultados das simula√ß√µes (ordena por Quina)
	@echo "üìä Comparando TOP 5 resultados..."
	$(GO) run $(BIN_COMPARE) -dir $(SIM_OUT) -n 5 -sort quina

test-preds: setup build ## Testa taxa de obter ao menos 1 terno variando jogos entre 10 e 25 (concorrente)
	@echo "üî¨ Teste preds=10..25 (concorrente, threads: 27, runs: $(PORTFOLIO_RUNS))"
	@$(GO) run $(BIN_CONCURRENCY) \
		-main-bin=$(MAIN_BIN) \
		-threads=27 \
		-runs=$(PORTFOLIO_RUNS) \
		-min-preds=10 -max-preds=25 -preds-step=5 \
		-alpha-min=$(ALPHA_MIN) -alpha-max=$(ALPHA_MAX) \
		-beta-min=$(BETA_MIN) -beta-max=$(BETA_MAX) \
		-lambda-min=$(LAMBDA_MIN) -lambda-max=$(LAMBDA_MAX) \
		-base-cmd='$(PORTFOLIO_BASE_CMD)'

# Vari√°veis configur√°veis (pode sobrescrever via env/make):
# Ex: make gen-contest TARGET_CONTEST=7000 TARGET_GAMES=30
TARGET_CONTEST ?= 6882
TARGET_GAMES ?= 25
TARGET_LIMIT ?= $(shell expr $(TARGET_CONTEST) - 1)

# Par√¢metros do gerador (padr√µes herdados do topo do Makefile)
GEN_LAMBDA ?= $(LAMBDA)
GEN_HOT_COLD_BOOST ?= $(HOT_COLD_BOOST)
GEN_ALPHA ?= $(ALPHA)
GEN_BETA ?= $(BETA)
GEN_GAMMA ?= $(GAMMA)
GEN_CLUSTER_PENALTY ?= $(CLUSTER_PENALTY)
GEN_CANDS_MULT ?= $(CANDS_MULT)
GEN_HILL_ITER ?= $(HILL_ITER)
GEN_COOCC_WINDOW ?= $(COOCC_WINDOW)
GEN_HOT_WINDOW ?= $(HOT_WINDOW)
GEN_SMART_FILTERS ?= $(SMART_FILTERS)
GEN_SEED ?= $(SEED)

# Arquivos de sa√≠da (podem ser sobrescritos)
GEN_OUT ?= $(DATA_DIR)/generated_$(TARGET_CONTEST).txt
COMPARE_OUT ?= $(DATA_DIR)/compare_$(TARGET_CONTEST).txt

.PHONY: gen-contest
gen-contest: init-db ## Gera $(TARGET_GAMES) cart√µes para o concurso $(TARGET_CONTEST) usando hist√≥rico at√© $(TARGET_LIMIT)
	@echo "üéØ Gerando $(TARGET_GAMES) cartoes para o concurso $(TARGET_CONTEST) (hist√≥rico at√© $(TARGET_LIMIT))"
	$(GO) run $(BIN_MAIN) --db $(DB) --load=false \
		--gen-games=$(TARGET_GAMES) --limit-contest=$(TARGET_LIMIT) \
		--lambda=$(GEN_LAMBDA) --hot-cold-boost=$(GEN_HOT_COLD_BOOST) \
		--alpha=$(GEN_ALPHA) --beta=$(GEN_BETA) --gamma=$(GEN_GAMMA) \
		--cluster-penalty=$(GEN_CLUSTER_PENALTY) \
		--cands-mult=$(GEN_CANDS_MULT) --hill-iter=$(GEN_HILL_ITER) \
		--coocc-window=$(GEN_COOCC_WINDOW) --hot-window=$(GEN_HOT_WINDOW) \
		--smart-filters=$(GEN_SMART_FILTERS) --seed=$(GEN_SEED) | tee $(GEN_OUT)

.PHONY: compare-contest
compare-contest: gen-contest
	@echo "üîé Comparando os $(TARGET_GAMES) cartoes com o resultado do concurso $(TARGET_CONTEST)"
	$(GO) run tools/cards/compare_cards.go --db $(DB) --cards-file $(GEN_OUT) --contest=$(TARGET_CONTEST) | tee $(COMPARE_OUT)

# Certifique-se de ter esta vari√°vel definida no topo do Makefile:
# NUM_THREADS?= (vazio para default ou um n√∫mero como 27)
# MAIN_BIN=./main_bin
# BIN_CONCURRENCY=tools/concurrent_sweep.go

mega-sweep: setup clean build ## Roda $(SWEEP_RUNS) simula√ß√µes aleat√≥rias em paralelo e mostra o Top 5
	@echo "üöÄ Iniciando Mega-Sweep Concorrente: $(SWEEP_RUNS) configura√ß√µes (Threads: $(NUM_THREADS))"
	$(GO) run $(BIN_CONCURRENCY) \
		-main-bin=$(MAIN_BIN) \
		-threads=$(NUM_THREADS) \
		-runs=$(SWEEP_RUNS) \
		-alpha-min=$(ALPHA_MIN) -alpha-max=$(ALPHA_MAX) \
		-beta-min=$(BETA_MIN) -beta-max=$(BETA_MAX) \
		-lambda-min=$(LAMBDA_MIN) -lambda-max=$(LAMBDA_MAX) \
		-base-cmd='$(BASE_SWEEP_CMD)'
	@echo "Simula√ß√µes conclu√≠das. Analisando o TOP 5..."
	@$(MAKE) compare-top5

portfolio-sweep: setup clean build ## Otimiza a quantidade de jogos (10-25) com 100 configs para maximizar Terno
	@echo "üß™ Iniciando Portfolio-Sweep Concorrente (Otimiza√ß√£o de Portf√≥lio) (Threads: $(NUM_THREADS))"
	$(GO) run $(BIN_CONCURRENCY) \
		-main-bin=$(MAIN_BIN) \
		-threads=$(NUM_THREADS) \
		-runs=$(PORTFOLIO_RUNS) \
		-min-preds=$(MIN_PREDS) -max-preds=$(MAX_PREDS) -preds-step=$(PREDS_STEP) \
		-alpha-min=$(ALPHA_MIN) -alpha-max=$(ALPHA_MAX) \
		-beta-min=$(BETA_MIN) -beta-max=$(BETA_MAX) \
		-lambda-min=$(LAMBDA_MIN) -lambda-max=$(LAMBDA_MAX) \
		-base-cmd='$(BASE_SWEEP_CMD)'
	@echo "Simula√ß√µes conclu√≠das. Analisando o TOP 5 por Terno..."
	@$(MAKE) compare-portfolio

compare-portfolio: ## Analisa os TOP 5 resultados por Terno (Exato)
	@echo "üìä Comparando TOP 5 resultados ordenados por TERNO..."
	$(GO) run $(BIN_COMPARE) -dir $(SIM_OUT) -n 5 -sort terno